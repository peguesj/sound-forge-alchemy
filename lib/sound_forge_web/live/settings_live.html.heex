<a
  href="#main-content"
  class="sr-only focus:not-sr-only focus:absolute focus:z-50 focus:top-2 focus:left-2 focus:px-4 focus:py-2 focus:bg-purple-600 focus:text-white focus:rounded-lg focus:outline-none"
>
  Skip to content
</a>
<div id="main-content" data-theme="dark" class="min-h-screen bg-gray-950 text-white">
  <!-- Header -->
  <header class="bg-gray-900 border-b border-gray-800 px-4 sm:px-6 py-4" role="banner">
    <div class="flex items-center justify-between">
      <.link
        navigate={~p"/"}
        class="text-2xl font-bold text-purple-400 hover:text-purple-300 transition-colors"
      >
        Sound Forge Alchemy
      </.link>
      <span class="text-sm text-gray-500">Settings</span>
    </div>
  </header>
  
<!-- Flash Messages -->
  <div
    :if={Phoenix.Flash.get(@flash, :info)}
    id="flash-info"
    role="alert"
    aria-live="polite"
    style="display:none;"
    class="mx-4 sm:mx-6 mt-3 flex items-center gap-3 bg-purple-900/30 border border-purple-700/50 text-purple-200 rounded-lg px-4 py-3 text-sm"
    phx-mounted={
      JS.show(transition: {"transition-opacity duration-300", "opacity-0", "opacity-100"})
      |> JS.hide(
        transition: {"transition-opacity duration-500", "opacity-100", "opacity-0"},
        time: 4000
      )
    }
    phx-click={
      JS.push("lv:clear-flash", value: %{key: :info})
      |> JS.hide(
        to: "#flash-info",
        transition: {"transition-opacity duration-300", "opacity-100", "opacity-0"}
      )
    }
  >
    <span class="flex-1">{Phoenix.Flash.get(@flash, :info)}</span>
    <button type="button" class="text-purple-400 hover:text-white" aria-label="Dismiss">
      &times;
    </button>
  </div>
  <div
    :if={Phoenix.Flash.get(@flash, :error)}
    id="flash-error"
    role="alert"
    aria-live="assertive"
    style="display:none;"
    class="mx-4 sm:mx-6 mt-3 flex items-center gap-3 bg-red-900/30 border border-red-700/50 text-red-200 rounded-lg px-4 py-3 text-sm"
    phx-mounted={
      JS.show(transition: {"transition-opacity duration-300", "opacity-0", "opacity-100"})
      |> JS.hide(
        transition: {"transition-opacity duration-500", "opacity-100", "opacity-0"},
        time: 4000
      )
    }
    phx-click={
      JS.push("lv:clear-flash", value: %{key: :error})
      |> JS.hide(
        to: "#flash-error",
        transition: {"transition-opacity duration-300", "opacity-100", "opacity-0"}
      )
    }
  >
    <span class="flex-1">{Phoenix.Flash.get(@flash, :error)}</span>
    <button type="button" class="text-red-400 hover:text-white" aria-label="Dismiss">
      &times;
    </button>
  </div>

  <div class="flex flex-col md:flex-row px-4 sm:px-6 py-6 gap-6">
    <!-- Sidebar -->
    <nav class="w-full md:w-48 md:shrink-0" aria-label="Settings sections">
      <ul class="flex md:flex-col gap-1 overflow-x-auto md:overflow-visible pb-2 md:pb-0 -mx-4 px-4 sm:-mx-6 sm:px-6 md:mx-0 md:px-0">
        <li :for={section <- ~w(spotify downloads youtube demucs cloud_separation analysis storage general advanced ai_providers)a}>
          <button
            phx-click="switch_section"
            phx-value-section={section}
            aria-current={if(@section == section, do: "page", else: false)}
            class={[
              "w-auto md:w-full text-left px-3 py-2 rounded-lg text-sm whitespace-nowrap transition-colors",
              if(@section == section,
                do: "bg-purple-900/50 text-purple-300 font-medium border-l-2 border-purple-400",
                else: "text-gray-400 hover:text-white hover:bg-gray-800"
              )
            ]}
          >
            {section_label(section)}
          </button>
        </li>
      </ul>
    </nav>
    
<!-- Content -->
    <div class="flex-1 w-full max-w-2xl">
      <.form for={@form} phx-change="validate" phx-submit="save" class="space-y-6">
        <!-- Validation Error Summary -->
        <div
          :if={@form.errors != []}
          role="alert"
          class="bg-red-900/20 border border-red-800/50 rounded-lg p-3 text-sm text-red-300"
        >
          Please fix the errors below before saving.
        </div>
        
<!-- Spotify Section -->
        <div :if={@section == :spotify}>
          <div
            id="section-content-spotify"
            style="display:none;"
            class="space-y-6"
            phx-mounted={
              JS.show(
                transition:
                  {"transition-all duration-200 ease-out", "opacity-0 translate-y-1",
                   "opacity-100 translate-y-0"}
              )
            }
          >
            <div>
              <div class="flex items-center justify-between">
                <h2
                  id="section-heading-spotify"
                  tabindex="-1"
                  class="text-lg font-semibold text-white"
                >
                  Spotify Integration
                </h2>
                <button
                  type="button"
                  phx-click="reset_section"
                  phx-value-section="spotify"
                  class="text-xs text-gray-500 hover:text-gray-300"
                >
                  Reset to defaults
                </button>
              </div>
              <p class="text-sm text-gray-500 mt-1">
                Manage your Spotify connection and monitor tool availability.
              </p>
            </div>
            
<!-- OAuth Status -->
            <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
              <h3 class="text-sm font-medium text-gray-300 mb-3">Spotify Account</h3>
              <div class="flex flex-wrap items-center gap-3">
                <div
                  aria-hidden="true"
                  class={[
                    "w-2 h-2 rounded-full",
                    if(@spotify_linked, do: "bg-green-500", else: "bg-gray-600")
                  ]}
                >
                </div>
                <span class="text-sm text-gray-400">
                  {if @spotify_linked, do: "Connected", else: "Not connected"}
                </span>
                <div class="sm:ml-auto w-full sm:w-auto mt-2 sm:mt-0">
                  <%= if @spotify_linked do %>
                    <button
                      type="button"
                      phx-click="unlink_spotify"
                      class="w-full sm:w-auto px-3 py-1.5 text-xs bg-red-900/30 text-red-400 rounded-lg hover:bg-red-900/50 border border-red-800/50"
                    >
                      Unlink
                    </button>
                  <% else %>
                    <button
                      type="button"
                      phx-click="link_spotify"
                      class="w-full sm:w-auto px-3 py-1.5 text-xs bg-green-900/30 text-green-400 rounded-lg hover:bg-green-900/50 border border-green-800/50"
                    >
                      Link Spotify
                    </button>
                  <% end %>
                </div>
              </div>
              <p class="text-xs text-gray-500 mt-2">
                Linking your Spotify account enables access to private playlists, saved tracks, and playback state.
                Without it, public playlist data is fetched via embed page fallback.
              </p>
            </div>
            
<!-- Tool Availability -->
            <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
              <h3 class="text-sm font-medium text-gray-300 mb-3">Tool Status</h3>
              <div class="space-y-2" role="list" aria-label="Tool availability">
                <div class="flex items-center gap-2" role="listitem">
                  <span class={[
                    "inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium",
                    if(@spotdl_available,
                      do: "bg-green-900/30 text-green-400",
                      else: "bg-red-900/30 text-red-400"
                    )
                  ]}>
                    <div
                      aria-hidden="true"
                      class={[
                        "w-1.5 h-1.5 rounded-full",
                        if(@spotdl_available, do: "bg-green-400", else: "bg-red-400")
                      ]}
                    >
                    </div>
                    {if @spotdl_available, do: "Available", else: "Not Found"}
                  </span>
                  <span class="text-sm text-gray-400">
                    SpotDL (Python + spotipy + yt-dlp)
                  </span>
                </div>
                <div class="flex items-center gap-2" role="listitem">
                  <span class={[
                    "inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium",
                    if(@ffmpeg_available,
                      do: "bg-green-900/30 text-green-400",
                      else: "bg-red-900/30 text-red-400"
                    )
                  ]}>
                    <div
                      aria-hidden="true"
                      class={[
                        "w-1.5 h-1.5 rounded-full",
                        if(@ffmpeg_available, do: "bg-green-400", else: "bg-red-400")
                      ]}
                    >
                    </div>
                    {if @ffmpeg_available, do: "Available", else: "Not Found"}
                  </span>
                  <span class="text-sm text-gray-400">FFmpeg</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
<!-- Downloads Section -->
        <div :if={@section == :downloads}>
          <div
            id="section-content-downloads"
            style="display:none;"
            class="space-y-6"
            phx-mounted={
              JS.show(
                transition:
                  {"transition-all duration-200 ease-out", "opacity-0 translate-y-1",
                   "opacity-100 translate-y-0"}
              )
            }
          >
            <div>
              <div class="flex items-center justify-between">
                <h2
                  id="section-heading-downloads"
                  tabindex="-1"
                  class="text-lg font-semibold text-white"
                >
                  Download Settings
                </h2>
                <button
                  type="button"
                  phx-click="reset_section"
                  phx-value-section="downloads"
                  class="text-xs text-gray-500 hover:text-gray-300"
                >
                  Reset to defaults
                </button>
              </div>
              <p class="text-sm text-gray-500 mt-1">
                Configure audio quality, format, and output location for downloads.
              </p>
            </div>

            <div class="bg-gray-900/50 rounded-lg p-5 border border-gray-800/50 space-y-4">
              <.input
                field={@form[:download_quality]}
                type="select"
                label="Download Quality"
                prompt={"Default (#{@defaults.download_quality})"}
                options={[
                  {"128 kbps", "128k"},
                  {"192 kbps", "192k"},
                  {"256 kbps", "256k"},
                  {"320 kbps", "320k"}
                ]}
              />

              <.input
                field={@form[:audio_format]}
                type="select"
                label="Audio Format"
                prompt={"Default (#{@defaults.audio_format})"}
                options={[{"MP3", "mp3"}, {"FLAC", "flac"}, {"WAV", "wav"}, {"OGG", "ogg"}]}
              />

              <div>
                <.input
                  field={@form[:output_directory]}
                  type="text"
                  label="Output Directory"
                  placeholder={@defaults.output_directory}
                  aria-describedby="output-directory-help"
                />
                <p id="output-directory-help" class="mt-1 text-xs text-gray-500">
                  Absolute path where downloaded tracks are saved. Defaults to the application storage directory.
                </p>
              </div>
            </div>
          </div>
        </div>
        
<!-- YouTube Section -->
        <div :if={@section == :youtube}>
          <div
            id="section-content-youtube"
            style="display:none;"
            class="space-y-6"
            phx-mounted={
              JS.show(
                transition:
                  {"transition-all duration-200 ease-out", "opacity-0 translate-y-1",
                   "opacity-100 translate-y-0"}
              )
            }
          >
            <div>
              <div class="flex items-center justify-between">
                <h2
                  id="section-heading-youtube"
                  tabindex="-1"
                  class="text-lg font-semibold text-white"
                >
                  YouTube / yt-dlp Settings
                </h2>
                <button
                  type="button"
                  phx-click="reset_section"
                  phx-value-section="youtube"
                  class="text-xs text-gray-500 hover:text-gray-300"
                >
                  Reset to defaults
                </button>
              </div>
              <p class="text-sm text-gray-500 mt-1">
                Tune yt-dlp search and format preferences for YouTube audio extraction.
              </p>
            </div>

            <div class="bg-gray-900/50 rounded-lg p-5 border border-gray-800/50 space-y-4">
              <div>
                <.input
                  field={@form[:ytdlp_search_depth]}
                  type="number"
                  label="Search Depth"
                  placeholder={to_string(@defaults.ytdlp_search_depth)}
                  min="1"
                  max="20"
                  aria-describedby="search-depth-help"
                />
                <p id="search-depth-help" class="mt-1 text-xs text-gray-500">
                  Number of YouTube search results to evaluate when matching a track. Higher values improve accuracy but slow downloads.
                </p>
              </div>

              <.input
                field={@form[:ytdlp_preferred_format]}
                type="select"
                label="Preferred Format"
                prompt={"Default (#{@defaults.ytdlp_preferred_format})"}
                options={[
                  {"Best Audio", "bestaudio"},
                  {"Best Audio/Best", "bestaudio/best"},
                  {"Best", "best"}
                ]}
              />

              <.input
                field={@form[:ytdlp_bitrate]}
                type="select"
                label="Bitrate"
                prompt={"Default (#{@defaults.ytdlp_bitrate})"}
                options={[
                  {"128 kbps", "128k"},
                  {"192 kbps", "192k"},
                  {"256 kbps", "256k"},
                  {"320 kbps", "320k"}
                ]}
              />
            </div>
          </div>
        </div>
        
<!-- Demucs Section -->
        <div :if={@section == :demucs} class="space-y-6">
          <div>
            <div class="flex items-center justify-between">
              <h2
                id="section-heading-demucs"
                tabindex="-1"
                class="text-lg font-semibold text-white"
              >
                Demucs Settings
              </h2>
              <button
                type="button"
                phx-click="reset_section"
                phx-value-section="demucs"
                class="text-xs text-gray-500 hover:text-gray-300"
              >
                Reset to defaults
              </button>
            </div>
            <p class="text-sm text-gray-500 mt-1">
              Configure the AI stem separation model, device, and output settings.
            </p>
          </div>

          <div class="bg-gray-900/50 rounded-lg p-5 border border-gray-800/50 space-y-4">
            <div>
              <.input
                field={@form[:demucs_model]}
                type="select"
                label="Model"
                prompt={"Default (#{@defaults.demucs_model})"}
                options={[
                  {"HTDemucs", "htdemucs"},
                  {"HTDemucs Fine-tuned", "htdemucs_ft"},
                  {"HTDemucs 6-Source", "htdemucs_6s"},
                  {"MDX Extra", "mdx_extra"}
                ]}
                aria-describedby="demucs-model-help"
              />
              <p id="demucs-model-help" class="mt-1 text-xs text-gray-500">
                The neural network model used for stem separation. Fine-tuned variants offer better quality at the cost of speed.
              </p>
            </div>

            <.input
              field={@form[:demucs_output_format]}
              type="select"
              label="Output Format"
              prompt={"Default (#{@defaults.demucs_output_format})"}
              options={[{"WAV", "wav"}, {"FLAC", "flac"}, {"MP3", "mp3"}]}
            />

            <.input
              field={@form[:demucs_device]}
              type="select"
              label="Device"
              prompt={"Default (#{@defaults.demucs_device})"}
              options={[{"CPU", "cpu"}, {"CUDA (GPU)", "cuda"}]}
            />

            <div>
              <.input
                field={@form[:demucs_timeout]}
                type="number"
                label="Timeout (ms)"
                placeholder={to_string(@defaults.demucs_timeout)}
                min="1"
                aria-describedby="demucs-timeout-help"
              />
              <p id="demucs-timeout-help" class="mt-1 text-xs text-gray-500">
                Maximum time in milliseconds to wait for a stem separation job before it is cancelled.
              </p>
            </div>
          </div>
        </div>
        
<!-- Cloud Separation Section -->
        <div :if={@section == :cloud_separation}>
          <div
            id="section-content-cloud-separation"
            style="display:none;"
            class="space-y-6"
            phx-mounted={
              JS.show(
                transition:
                  {"transition-all duration-200 ease-out", "opacity-0 translate-y-1",
                   "opacity-100 translate-y-0"}
              )
            }
          >
            <div>
              <h2
                id="section-heading-cloud-separation"
                tabindex="-1"
                class="text-lg font-semibold text-white"
              >
                Cloud Stem Separation (lalal.ai)
              </h2>
              <p class="text-sm text-gray-500 mt-1">
                Configure your lalal.ai API key for cloud-based stem separation.
                Cloud processing supports more stem types and does not require local GPU resources.
              </p>
            </div>

            <!-- API Key Status -->
            <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
              <h3 class="text-sm font-medium text-gray-300 mb-3">API Key Status</h3>
              <div class="flex flex-wrap items-center gap-3">
                <div
                  aria-hidden="true"
                  class={[
                    "w-2 h-2 rounded-full",
                    if(@lalalai_configured, do: "bg-green-500", else: "bg-gray-600")
                  ]}
                >
                </div>
                <span class="text-sm text-gray-400">
                  {if @lalalai_configured, do: "API key configured", else: "Not configured"}
                </span>
                <button
                  :if={@lalalai_configured}
                  type="button"
                  phx-click="remove_lalalai_key"
                  class="sm:ml-auto px-3 py-1.5 text-xs bg-red-900/30 text-red-400 rounded-lg hover:bg-red-900/50 border border-red-800/50"
                >
                  Remove Key
                </button>
              </div>
              <p class="text-xs text-gray-500 mt-2">
                Your API key is stored encrypted. It is used only for lalal.ai API requests.
              </p>
            </div>

            <!-- API Key Input -->
            <div class="bg-gray-900/50 rounded-lg p-5 border border-gray-800/50 space-y-4">
              <div>
                <label for="lalalai-api-key" class="block text-sm font-medium text-gray-300 mb-2">
                  {if @lalalai_configured, do: "Update API Key", else: "Enter API Key"}
                </label>
                <form phx-change="lalalai_key_input" phx-submit="test_lalalai_key">
                  <input
                    type="password"
                    id="lalalai-api-key"
                    name="key"
                    value={@lalalai_api_key_input}
                    placeholder="Enter your lalal.ai API key"
                    autocomplete="off"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:border-purple-500 focus:ring-1 focus:ring-purple-500 focus:outline-none"
                    aria-describedby="lalalai-key-help"
                  />
                </form>
                <p id="lalalai-key-help" class="mt-1 text-xs text-gray-500">
                  Get your API key from
                  <a
                    href="https://www.lalal.ai/developer/"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-purple-400 hover:text-purple-300 underline"
                  >
                    lalal.ai Developer Portal
                  </a>
                </p>
              </div>

              <!-- Test Result -->
              <div
                :if={@lalalai_test_result}
                class={[
                  "flex items-center gap-2 rounded-lg px-3 py-2 text-sm",
                  case @lalalai_test_result do
                    {:ok, _} -> "bg-green-900/30 border border-green-700/50 text-green-300"
                    {:error, _} -> "bg-red-900/30 border border-red-700/50 text-red-300"
                  end
                ]}
              >
                <%= case @lalalai_test_result do %>
                  <% {:ok, msg} -> %>
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span>{msg}</span>
                  <% {:error, msg} -> %>
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <span>{msg}</span>
                <% end %>
              </div>

              <!-- Action Buttons -->
              <div class="flex flex-col sm:flex-row gap-2">
                <button
                  type="button"
                  phx-click="test_lalalai_key"
                  disabled={@lalalai_testing || @lalalai_api_key_input == ""}
                  class="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-gray-700 text-gray-200 rounded-lg hover:bg-gray-600 transition-colors text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <svg :if={!@lalalai_testing} class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <svg :if={@lalalai_testing} class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
                  </svg>
                  {if @lalalai_testing, do: "Testing...", else: "Test & Save"}
                </button>
                <button
                  type="button"
                  phx-click="save_lalalai_key"
                  disabled={@lalalai_api_key_input == ""}
                  class="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Save Without Testing
                </button>
              </div>
            </div>

            <!-- Quota Display -->
            <div :if={@lalalai_configured} class="bg-gray-900 rounded-lg p-4 border border-gray-800">
              <div class="flex items-center justify-between">
                <h3 class="text-sm font-medium text-gray-300">API Quota</h3>
                <span class="text-xs text-gray-500">Refreshes every 60s</span>
              </div>
              <div class="mt-2">
                <span :if={@lalalai_quota} class="text-2xl font-semibold text-white">
                  {Float.round(@lalalai_quota * 1.0, 1)}
                </span>
                <span :if={@lalalai_quota} class="text-sm text-gray-400 ml-1">minutes remaining</span>
                <span :if={is_nil(@lalalai_quota)} class="text-sm text-gray-500">Fetching quota...</span>
              </div>
            </div>

            <!-- Advanced lalal.ai Options -->
            <div class="bg-gray-900/50 rounded-lg p-5 border border-gray-800/50 space-y-5">
              <h3 class="text-sm font-medium text-gray-300">Processing Options</h3>

              <.input
                field={@form[:lalalai_splitter]}
                type="select"
                label="Splitter Model"
                options={[
                  {"Phoenix (default)", "phoenix"},
                  {"Orion", "orion"},
                  {"Perseus", "perseus"},
                  {"Andromeda", "andromeda"},
                  {"Lyra", "lyra"}
                ]}
                prompt="Use default (phoenix)"
                class="bg-gray-800 border-gray-700 text-white"
              />

              <.input
                field={@form[:lalalai_extraction_level]}
                type="select"
                label="Extraction Level"
                options={[
                  {"Clear Cut (default)", "clear_cut"},
                  {"Deep Extraction", "deep_extraction"},
                  {"Normal", "normal"},
                  {"Mild", "mild"}
                ]}
                prompt="Use default (clear cut)"
                class="bg-gray-800 border-gray-700 text-white"
              />

              <.input
                field={@form[:lalalai_output_format]}
                type="select"
                label="Output Format"
                options={[
                  {"MP3", "mp3"},
                  {"WAV", "wav"},
                  {"FLAC", "flac"},
                  {"AAC", "aac"},
                  {"OGG", "ogg"}
                ]}
                prompt="Auto (use source format)"
                class="bg-gray-800 border-gray-700 text-white"
              />

              <.input
                field={@form[:lalalai_dereverb]}
                type="checkbox"
                label="Enable De-reverb"
              />
              <p class="text-xs text-gray-500 -mt-2">
                Remove room reverb from separated stems. Improves clarity in reverb-heavy recordings.
              </p>
            </div>

            <!-- Supported Stem Types -->
            <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
              <h3 class="text-sm font-medium text-gray-300 mb-3">Supported Stem Types</h3>
              <div class="flex flex-wrap gap-2">
                <span
                  :for={filter <- ~w(vocals drum bass piano electricguitar acousticguitar synthesizer strings winds)}
                  class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-purple-900/30 text-purple-300 border border-purple-700/50"
                >
                  {filter}
                </span>
              </div>
              <p class="text-xs text-gray-500 mt-3">
                Cloud separation via lalal.ai supports more stem types than local Demucs,
                including individual instruments like piano, electric guitar, and synthesizer.
              </p>
            </div>
          </div>
        </div>

<!-- Analysis Section -->
        <div :if={@section == :analysis} class="space-y-6">
          <div class="flex items-center justify-between">
            <h2
              id="section-heading-analysis"
              tabindex="-1"
              class="text-lg font-semibold text-white"
            >
              Analysis Settings
            </h2>
            <button
              type="button"
              phx-click="reset_section"
              phx-value-section="analysis"
              class="text-xs text-gray-500 hover:text-gray-300"
            >
              Reset to defaults
            </button>
          </div>

          <fieldset class="space-y-2">
            <legend class="text-sm text-gray-300">Analysis Features</legend>
            <div class="space-y-1" role="group" aria-label="Analysis features selection">
              <.input
                :for={feature <- ~w(tempo key energy spectral)}
                field={@form[:analysis_features]}
                id={"user_settings_analysis_features_#{feature}"}
                type="checkbox"
                label={String.capitalize(feature)}
                name="user_settings[analysis_features][]"
                value={feature}
                checked={
                  feature in (@form[:analysis_features].value || @defaults.analysis_features || [])
                }
              />
            </div>
          </fieldset>

          <.input
            field={@form[:analyzer_timeout]}
            type="number"
            label="Analyzer Timeout (ms)"
            placeholder={to_string(@defaults.analyzer_timeout)}
            min="1"
          />
        </div>
        
<!-- Storage Section -->
        <div :if={@section == :storage} class="space-y-6">
          <div class="flex items-center justify-between">
            <h2
              id="section-heading-storage"
              tabindex="-1"
              class="text-lg font-semibold text-white"
            >
              Storage Settings
            </h2>
            <button
              type="button"
              phx-click="reset_section"
              phx-value-section="storage"
              class="text-xs text-gray-500 hover:text-gray-300"
            >
              Reset to defaults
            </button>
          </div>

          <div>
            <.input
              field={@form[:storage_path]}
              type="text"
              label="Storage Path"
              placeholder={@defaults.storage_path}
              aria-describedby="storage-path-help"
            />
            <p id="storage-path-help" class="mt-1 text-xs text-gray-500">
              Root directory for all application data including stems, analyses, and temporary files.
            </p>
          </div>

          <.input
            field={@form[:max_file_age_days]}
            type="number"
            label="Max File Age (days)"
            placeholder={to_string(@defaults.max_file_age_days)}
            min="1"
          />

          <.input
            field={@form[:retention_days]}
            type="number"
            label="Retention Period (days)"
            placeholder={to_string(@defaults.retention_days)}
            min="1"
          />
        </div>
        
<!-- General Section -->
        <div :if={@section == :general} class="space-y-6">
          <div class="flex items-center justify-between">
            <h2
              id="section-heading-general"
              tabindex="-1"
              class="text-lg font-semibold text-white"
            >
              General Settings
            </h2>
            <button
              type="button"
              phx-click="reset_section"
              phx-value-section="general"
              class="text-xs text-gray-500 hover:text-gray-300"
            >
              Reset to defaults
            </button>
          </div>

          <.input
            field={@form[:tracks_per_page]}
            type="number"
            label="Tracks Per Page"
            placeholder={to_string(@defaults.tracks_per_page)}
            min="1"
            max="100"
          />

          <.input
            field={@form[:max_upload_size]}
            type="number"
            label="Max Upload Size (bytes)"
            placeholder={to_string(@defaults.max_upload_size)}
            min="1"
          />
        </div>
        
<!-- Advanced Section -->
        <div :if={@section == :advanced} class="space-y-6">
          <div class="flex items-center justify-between">
            <h2
              id="section-heading-advanced"
              tabindex="-1"
              class="text-lg font-semibold text-white"
            >
              Advanced Settings
            </h2>
          </div>

          <div class="bg-gray-900/50 rounded-lg p-5 border border-gray-800/50 space-y-4">
            <div class="flex items-center justify-between">
              <div>
                <label for="user_settings_debug_mode" class="text-sm font-medium text-gray-300">
                  Debug Mode
                </label>
                <p class="text-xs text-gray-500 mt-0.5">
                  Enable the debug inspector panel on the dashboard for real-time logs, job tracing, worker status, and queue monitoring.
                </p>
              </div>
              <input
                type="hidden"
                name="user_settings[debug_mode]"
                value="false"
              />
              <input
                type="checkbox"
                id="user_settings_debug_mode"
                name="user_settings[debug_mode]"
                value="true"
                checked={@form[:debug_mode].value == true || @form[:debug_mode].value == "true"}
                class="toggle toggle-primary"
              />
            </div>
          </div>
        </div>

<!-- AI Providers Section -->
        <div :if={@section == :ai_providers}>
          <div
            id="section-content-ai-providers"
            style="display:none;"
            class="space-y-6"
            phx-mounted={
              JS.show(
                transition:
                  {"transition-all duration-200 ease-out", "opacity-0 translate-y-1",
                   "opacity-100 translate-y-0"}
              )
            }
          >
            <div>
              <h2
                id="section-heading-ai-providers"
                tabindex="-1"
                class="text-lg font-semibold text-white"
              >
                AI Providers
              </h2>
              <p class="text-sm text-gray-500 mt-1">
                Configure LLM providers for Chef AI, agentic features, and intelligent routing.
                LiteLLM is recommended as a unified proxy for all cloud and local models.
              </p>
            </div>

            <!-- Provider List -->
            <div class="space-y-2">
              <div
                :if={@llm_providers == []}
                class="bg-gray-900/50 rounded-lg p-5 border border-gray-800/50 text-center text-sm text-gray-500"
              >
                No providers configured. Add one below.
              </div>

              <div
                :for={provider <- @llm_providers}
                class="bg-gray-900 rounded-lg p-4 border border-gray-800 flex flex-col sm:flex-row sm:items-center gap-3"
              >
                <div class="flex items-center gap-3 flex-1 min-w-0">
                  <!-- Health dot -->
                  <div
                    class={"w-2 h-2 rounded-full shrink-0 #{provider_health_class(provider.health_status)}"}
                    title={to_string(provider.health_status)}
                  >
                  </div>
                  <div class="min-w-0">
                    <p class="text-sm font-medium text-white truncate">{provider.name}</p>
                    <p class="text-xs text-gray-500">
                      {provider_type_label(provider.provider_type)}
                      {if provider.default_model && provider.default_model != "",
                        do: " · #{provider.default_model}",
                        else: ""}
                      · priority #{provider.priority}
                    </p>
                  </div>
                </div>

                <div class="flex items-center gap-2 shrink-0">
                  <!-- Enabled toggle -->
                  <button
                    type="button"
                    phx-click="toggle_provider"
                    phx-value-id={provider.id}
                    class={[
                      "relative inline-flex h-5 w-9 shrink-0 items-center rounded-full transition-colors",
                      if(provider.enabled, do: "bg-purple-600", else: "bg-gray-700")
                    ]}
                    title={if(provider.enabled, do: "Disable", else: "Enable")}
                  >
                    <span class={[
                      "inline-block h-3.5 w-3.5 transform rounded-full bg-white transition-transform",
                      if(provider.enabled, do: "translate-x-4", else: "translate-x-0.5")
                    ]} />
                  </button>

                  <!-- Test -->
                  <button
                    type="button"
                    phx-click="test_provider"
                    phx-value-id={provider.id}
                    disabled={@provider_testing_id == provider.id}
                    class="px-2 py-1 text-xs bg-gray-700 text-gray-300 rounded hover:bg-gray-600 disabled:opacity-50"
                    title="Test connection"
                  >
                    {if @provider_testing_id == provider.id, do: "Testing...", else: "Test"}
                  </button>

                  <!-- Edit -->
                  <button
                    type="button"
                    phx-click="edit_provider"
                    phx-value-id={provider.id}
                    class="px-2 py-1 text-xs bg-gray-700 text-gray-300 rounded hover:bg-gray-600"
                  >
                    Edit
                  </button>

                  <!-- Delete -->
                  <button
                    type="button"
                    phx-click="delete_provider"
                    phx-value-id={provider.id}
                    data-confirm="Remove this provider?"
                    class="px-2 py-1 text-xs bg-red-900/40 text-red-400 rounded hover:bg-red-900/60"
                  >
                    Remove
                  </button>
                </div>
              </div>
            </div>

            <!-- Add Provider Button -->
            <button
              :if={is_nil(@provider_form_mode)}
              type="button"
              phx-click="show_add_provider"
              class="w-full flex items-center justify-center gap-2 px-4 py-2 border border-dashed border-gray-700 text-gray-400 rounded-lg hover:border-purple-500 hover:text-purple-400 transition-colors text-sm"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              Add Provider
            </button>

            <!-- Provider Form -->
            <div :if={@provider_form_mode} class="bg-gray-900/50 rounded-lg p-5 border border-gray-800/50">
              <h3 class="text-sm font-semibold text-white mb-4">
                {if @provider_form_mode == :new, do: "Add Provider", else: "Edit Provider"}
              </h3>

              <.form
                for={@provider_form}
                phx-change="validate_provider"
                phx-submit="save_provider"
                class="space-y-4"
              >
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <.input
                    field={@provider_form[:provider_type]}
                    type="select"
                    label="Provider Type"
                    options={[
                      {"Anthropic", "anthropic"},
                      {"OpenAI", "openai"},
                      {"Azure OpenAI", "azure_openai"},
                      {"Google Gemini", "google_gemini"},
                      {"Ollama", "ollama"},
                      {"LM Studio", "lm_studio"},
                      {"LiteLLM (recommended)", "litellm"},
                      {"Custom OpenAI", "custom_openai"}
                    ]}
                    prompt="Select provider..."
                  />

                  <.input
                    field={@provider_form[:name]}
                    type="text"
                    label="Display Name"
                    placeholder="e.g. My Anthropic Key"
                  />
                </div>

                <!-- API key for cloud providers -->
                <div>
                  <.input
                    field={@provider_form[:api_key]}
                    type="password"
                    label="API Key"
                    placeholder="sk-..."
                    autocomplete="off"
                  />
                  <p class="mt-1 text-xs text-gray-500">Required for Anthropic, OpenAI, Azure, and Gemini.</p>
                </div>

                <!-- Base URL for local/proxy providers -->
                <div>
                  <.input
                    field={@provider_form[:base_url]}
                    type="text"
                    label="Base URL"
                    placeholder="http://localhost:11434"
                  />
                  <p class="mt-1 text-xs text-gray-500">Required for Ollama, LM Studio, LiteLLM, and custom endpoints.</p>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <.input
                    field={@provider_form[:default_model]}
                    type="text"
                    label="Default Model"
                    placeholder="e.g. claude-opus-4-6"
                  />

                  <.input
                    field={@provider_form[:priority]}
                    type="number"
                    label="Priority (lower = higher)"
                    placeholder="0"
                    min="0"
                  />
                </div>

                <.input
                  field={@provider_form[:enabled]}
                  type="checkbox"
                  label="Enabled"
                />

                <div class="flex gap-2 pt-2">
                  <button
                    type="submit"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium"
                  >
                    {if @provider_form_mode == :new, do: "Add Provider", else: "Save Changes"}
                  </button>
                  <button
                    type="button"
                    phx-click="cancel_provider_form"
                    class="px-4 py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 transition-colors text-sm"
                  >
                    Cancel
                  </button>
                </div>
              </.form>
            </div>

            <!-- Provider Tips -->
            <div class="bg-gray-900 rounded-lg p-4 border border-gray-800 text-xs text-gray-500 space-y-1">
              <p class="font-medium text-gray-400">Routing Priority</p>
              <p>LiteLLM is used first when configured, providing access to all cloud models through one endpoint. Local providers (Ollama, LM Studio) are tried for offline/privacy tasks. Lowest priority number = highest preference.</p>
            </div>
          </div>
        </div>

<!-- Save Button -->
        <div :if={@section not in [:spotify, :ai_providers]} class="pt-4 border-t border-gray-800">
          <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
            <button
              type="submit"
              phx-disable-with="Saving..."
              aria-busy="false"
              class="w-full sm:w-auto px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Save Settings
            </button>
            <div
              :if={@form_dirty}
              class="inline-flex items-center gap-1.5 text-xs text-amber-400"
              role="status"
              aria-live="polite"
            >
              <div class="w-1.5 h-1.5 rounded-full bg-amber-400 animate-pulse"></div>
              Unsaved changes
            </div>
          </div>
        </div>
      </.form>
    </div>
  </div>
</div>
