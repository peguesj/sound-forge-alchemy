# Ralph Progress Log
Started: Tue Feb 17 09:44:42 EST 2026
---

## US-001 - Add structured Oban telemetry logging with namespace scoping
- Implementation already existed in lib/sound_forge/telemetry/oban_handler.ex (GenServer with telemetry attach)
- Handler attached to [:oban, :job, :start], [:oban, :job, :stop], [:oban, :job, :exception]
- Logs with [oban.WorkerName] namespace, job_id, queue, attempt, duration_ms, result/status
- Logger.metadata set for structured fields: oban_job_id, oban_queue, oban_worker, oban_attempt
- config/config.exs already had metadata keys configured on line 110
- Fixed test file: capture_log tests were failing because test env Logger level is :warning, suppressing :info logs
- Added setup block to temporarily set Logger level to :debug, changed async to false
- Files changed: test/sound_forge/telemetry/oban_handler_test.exs
- Learnings: Test env sets `config :logger, level: :warning` -- capture_log level option filters captured output but does NOT override the global Logger level. Must use Logger.configure(level: :debug) in setup.
---

## US-002 - Add verbose SpotDL output capture and parse-failure diagnostics
- Added Logger.metadata(spotdl_cmd:) to fetch_metadata/1, download/2, download_direct/2 entry points
- Added :debug logging in collect_output/3 for each port data chunk (byte count) and raw output before stdout/stderr split (truncated to 2000 chars)
- Extracted parse_download_result/1 from inline Jason.decode calls in download/2 and download_direct/2
- parse_download_result scans lines in reverse for valid JSON result, logs :warning with raw output (2000 chars) on failure, includes first 200 chars in error tuple
- Expanded status_line?/1 to delegate to noise_line?/1 which filters: [download], [ExtractAudio], [ffmpeg], [youtube], [yt-dlp], [info], [generic], [debug], WARNING:, ERROR:, empty lines, and percentage progress patterns
- Files changed: lib/sound_forge/audio/spotdl.ex
- Learnings: yt-dlp emits many more bracketed prefixes than just [download]. The noise_prefixes module attribute + regex pattern for percentage lines provides comprehensive filtering.
---

## US-003 - Add DownloadWorker verbose lifecycle logging at every stage
- perform/1 now logs at :info on entry with track_id, spotify_url, quality, attempt/max_attempts (pattern-matched from Oban.Job)
- After SpotDL.download returns: added :debug log with result status and path/size or reason
- attempt_direct_fallback: logs title, artist, duration at :info level
- handle_download_success: logs output_path, file_size, and validation result at :debug
- enqueue_processing: logs processing_job_id and model at :info on successful enqueue
- All Logger calls use structured metadata with stage field (download|fallback|validate|enqueue)
- broadcast_progress and broadcast_track_progress now log PubSub messages at :debug
- Files changed: lib/sound_forge/jobs/download_worker.ex
- Learnings: Pattern-match Oban.Job struct fields (attempt, max_attempts) directly in perform/1 function head for cleaner access.
---

## US-004 - Add debug_mode user setting and migration
- Created migration: add debug_mode boolean to user_settings, default false, null false
- Added :debug_mode field to UserSettings schema (boolean, default: false)
- Added :debug_mode to @cast_fields for changeset
- Added debug_mode to Settings @defaults_map with fallback false
- Files changed: lib/sound_forge/accounts/user_settings.ex, lib/sound_forge/settings.ex, priv/repo/migrations/20260217145802_add_debug_mode_to_user_settings.exs
- Learnings: Simple data-layer stories are fast. The existing Settings pattern (nullable fields with global defaults) makes boolean flags easy to add.
---
