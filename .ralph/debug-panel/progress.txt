# Ralph Progress Log
Started: Tue Feb 17 09:44:42 EST 2026
---

## US-001 - Add structured Oban telemetry logging with namespace scoping
- Implementation already existed in lib/sound_forge/telemetry/oban_handler.ex (GenServer with telemetry attach)
- Handler attached to [:oban, :job, :start], [:oban, :job, :stop], [:oban, :job, :exception]
- Logs with [oban.WorkerName] namespace, job_id, queue, attempt, duration_ms, result/status
- Logger.metadata set for structured fields: oban_job_id, oban_queue, oban_worker, oban_attempt
- config/config.exs already had metadata keys configured on line 110
- Fixed test file: capture_log tests were failing because test env Logger level is :warning, suppressing :info logs
- Added setup block to temporarily set Logger level to :debug, changed async to false
- Files changed: test/sound_forge/telemetry/oban_handler_test.exs
- Learnings: Test env sets `config :logger, level: :warning` -- capture_log level option filters captured output but does NOT override the global Logger level. Must use Logger.configure(level: :debug) in setup.
---

## US-002 - Add verbose SpotDL output capture and parse-failure diagnostics
- Added Logger.metadata(spotdl_cmd:) to fetch_metadata/1, download/2, download_direct/2 entry points
- Added :debug logging in collect_output/3 for each port data chunk (byte count) and raw output before stdout/stderr split (truncated to 2000 chars)
- Extracted parse_download_result/1 from inline Jason.decode calls in download/2 and download_direct/2
- parse_download_result scans lines in reverse for valid JSON result, logs :warning with raw output (2000 chars) on failure, includes first 200 chars in error tuple
- Expanded status_line?/1 to delegate to noise_line?/1 which filters: [download], [ExtractAudio], [ffmpeg], [youtube], [yt-dlp], [info], [generic], [debug], WARNING:, ERROR:, empty lines, and percentage progress patterns
- Files changed: lib/sound_forge/audio/spotdl.ex
- Learnings: yt-dlp emits many more bracketed prefixes than just [download]. The noise_prefixes module attribute + regex pattern for percentage lines provides comprehensive filtering.
---

## US-003 - Add DownloadWorker verbose lifecycle logging at every stage
- perform/1 now logs at :info on entry with track_id, spotify_url, quality, attempt/max_attempts (pattern-matched from Oban.Job)
- After SpotDL.download returns: added :debug log with result status and path/size or reason
- attempt_direct_fallback: logs title, artist, duration at :info level
- handle_download_success: logs output_path, file_size, and validation result at :debug
- enqueue_processing: logs processing_job_id and model at :info on successful enqueue
- All Logger calls use structured metadata with stage field (download|fallback|validate|enqueue)
- broadcast_progress and broadcast_track_progress now log PubSub messages at :debug
- Files changed: lib/sound_forge/jobs/download_worker.ex
- Learnings: Pattern-match Oban.Job struct fields (attempt, max_attempts) directly in perform/1 function head for cleaner access.
---

## US-004 - Add debug_mode user setting and migration
- Created migration: add debug_mode boolean to user_settings, default false, null false
- Added :debug_mode field to UserSettings schema (boolean, default: false)
- Added :debug_mode to @cast_fields for changeset
- Added debug_mode to Settings @defaults_map with fallback false
- Files changed: lib/sound_forge/accounts/user_settings.ex, lib/sound_forge/settings.ex, priv/repo/migrations/20260217145802_add_debug_mode_to_user_settings.exs
- Learnings: Simple data-layer stories are fast. The existing Settings pattern (nullable fields with global defaults) makes boolean flags easy to add.
---

## US-005 - Build debug inspector slide-in panel shell with tab navigation
- Added debug panel assigns to DashboardLive mount: debug_mode, debug_panel_open, debug_tab, debug_workers_open, debug_queue_open
- Added event handlers: toggle_debug_panel, close_debug_panel, debug_tab (with atom validation), toggle_debug_workers, toggle_debug_queue
- Panel HTML: w-96 right panel as flex sibling of <main> inside body flex container
- Bug icon toggle button floated bottom-right, visible only when debug_mode=true
- Tab bar with Logs/Tracing tabs, active state highlighted with purple border
- Collapsible Workers/Queue sections with chevron rotation on expand
- Placeholder content for future US-006 through US-009
- Files changed: lib/sound_forge_web/live/dashboard_live.ex, lib/sound_forge_web/live/dashboard_live.html.heex
- Learnings: Placing the debug panel as a flex sibling of <main> (not a modal/overlay) keeps it in the natural document flow. Using :if conditionals for visibility instead of CSS display prevents unnecessary DOM. String.to_existing_atom/1 for tab validation prevents atom table pollution.
---

## US-006 - Implement real-time log streaming tab with color coding and filtering
- Created lib/sound_forge/debug/log_broadcaster.ex: custom :gen_event Logger backend
- Broadcasts to PubSub topic "debug:logs" with level, message, timestamp, metadata, namespace
- Namespace extracted via regex from [bracket.prefix] pattern in log messages
- Registered as additional Logger backend in config/dev.exs
- DashboardLive subscribes to "debug:logs" on mount when debug_mode enabled
- handle_info({:debug_log, event}) buffers logs (max 500) and tracks seen namespaces
- Logs tab UI: filter bar with level dropdown, namespace dropdown (auto-populated), text search with debounce
- Color coding: debug=gray, info=blue, warning=amber, error=red; error lines get red left border
- DebugLogScroll JS hook for auto-scroll (disables when user scrolls up)
- Files changed: lib/sound_forge/debug/log_broadcaster.ex, config/dev.exs, lib/sound_forge_web/live/dashboard_live.ex, lib/sound_forge_web/live/dashboard_live.html.heex, assets/js/hooks/debug_log_scroll.js, assets/js/app.js
- Learnings: Custom Logger backend in Elixir uses :gen_event behaviour, not GenServer. PubSub broadcast from a Logger backend works well for real-time log streaming. Buffer newest-first (prepend) and reverse for display gives O(1) insert.
---

## US-007 - Implement error and event tracing tab with dependency graph
- Created lib/sound_forge/debug/jobs.ex with recent_jobs/1, get_job/1, jobs_for_track/1 queries against oban_jobs table
- build_timeline/1 extracts lifecycle events (queued, started, completed/failed) from job timestamps
- build_graph/1 produces D3-ready {nodes, links} for the pipeline DAG (Download -> Processing -> Analysis)
- Added D3.js v7 dependency to assets/package.json
- Created assets/js/hooks/job_trace_graph.js: D3 SVG rendering with scalePoint layout, status-colored nodes, arrow markers, hover tooltips for errors
- Tracing tab UI: job selector dropdown populated on tab switch, refresh button, vertical timeline with color-coded events, pipeline graph container
- Added duration_since/2 helper with DateTime/NaiveDateTime support, format_duration_ms for ms/s/m display
- DashboardLive events: trace_select_job (fetches track jobs, builds timeline/graph, push_event to hook), trace_refresh
- Files changed: lib/sound_forge/debug/jobs.ex, assets/js/hooks/job_trace_graph.js, assets/js/app.js, assets/package.json, assets/package-lock.json, lib/sound_forge_web/live/dashboard_live.ex, lib/sound_forge_web/live/dashboard_live.html.heex
- Learnings: Querying oban_jobs with raw table name (string) instead of Oban.Job schema avoids coupling to Oban internals. D3 scalePoint with padding works well for small fixed-position node layouts. push_event from LiveView to JS hook is the right pattern for D3 data.
---
